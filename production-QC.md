# Production QC project

## 1 first try

### 1.1 first look of data

- training set: 9580 rows
- test set: 2430 rows

有少量的 missing value, 都出现在 param4 列


final y: 明显偏差的数据分布, 绝大部分都集中在 1 附近 (>0.9)

- 采样技术也可能需要(过采样低值, 在以相对偏差为主要质控时可能很重要)
- 考虑用聚类分析是否为异常值(异常低的 key\_index)

    np.log10(1.001 - training_set.key_index_x).hist(bins=100) ## 整理为更接近正态分布的 y

draft parameters:

- seems more like categorical data.
    - decision tree-based algorithms first

直接用 random forest 效果不佳. 过拟合表现.

初期还需要选择特征, 把基本的参数工程明白.

### 1.2 first submission

50, 10, 20 trees for random forest

只是为了看一下近似没有预测的结果...

然而因数据集更新, 没有采到有效数据.

### 1.3 plan

特征工程, 至少不能再过拟合(欠拟合无所谓). 从评估结果看一下自己的初步情况(其实初期自己写脚本已经足够用了).

## 2 RMSE QC

### 2.1 obj

一定要有自己的评估手段, 加快反馈循环.

### 2.2 工程

评估标准是 RMSE. 

写相关的评估函数, 并与参数归一化整合 `RMSE.ipynb`

### 2.3 初步评估

开始犯了个小错误: 评估的 y, y_pred 没有变换回原始的 [0,1] 区间.

note: 时刻保持对 pipeline 的理解, 必要时画结构图来理解流程, 避免此类问题.

评估 random forest, linear reg 的结果:

~~~
RF:
train 0.0424; test 0.0705

linear reg:
train 0.0691; test 0.0716
~~~

考虑 8.12 评测结果: 最优得分是 0.0675, 在 0.067-0.076 之间.

说明目前的数据优化空间从数值上来看不大. (但这一些微小的差距很可能需要大量的工程才能追上)

然而说实话, 目前没什么优化思路.

可能是因为对数据和业务都不理解吧...

决定先提交一次看看情况, 基本在 QC 之后可以弃坑了...

提交的是新数据集采用不同 RF(树的数量不同) 的结果.


### 2.4 dummy predictor

从目前情况来看, 还有一定的提升空间. 另外近几天实验上能做的事情不多, 于是计划继续分析两三天, 到周四/周五, 再决定周末是否提交.

继续理解数据和预测结果:

- 用 均值 / 全1 作为 dummy predictor, baseline 评估目前的预测水平, 以及可以期望的目标.
    - 目前 RF: train 0.4317 pred 0.7064
    - 用均值预测: train 0.6955 pred 0.7210 (test average 0.7194)
    - 结论: 目前的预测虽然不怎么样, 但比 baseline 显著好.

## 3 继续特征工程 draft / param

### 3.1 继续通过 plot 等方式理解数据和业务, 寻找可能的思路.

- 考虑是不是相同的输入参数会有很大的偏差 (即结果方差大)
    - 直接看数据可能是个办法
    - 可能结果更多的和生产过程是否正常有关
- 先集中在 draft 和 param 用一定时间分析

- param1/param2 作为两个选材参数近似相等. 怀疑是近似正方形的 长*宽
    - 分析一下相等和不等的 group 是否有显著差异?

### 3.2 可视化寻求单个变量和 y 的关系

用比较长的

类别型: 

draft_param1,2,3,10,11

- 1: 有一定差异, 除 0 离群较远(偏低), 其余几个相差不大
    
              count_nonzero      mean       std
    draft_param1                                   
    0                      25.0 -1.223018  0.448874
    1                     239.0 -1.518699  0.410279
    2                      35.0 -1.557707  0.357107
    3                    4959.0 -1.504268  0.393509
    4                     530.0 -1.438326  0.325457
    5                    3017.0 -1.489401  0.322244

- 2: 以 0 为主, 1 只占 5%, 比 0 差一些
                  count_nonzero      mean       std
    draft_param2                                   
    0                    8378.0 -1.498707  0.368759
    1                     427.0 -1.422487  0.339322
 
 - 3: 0/1 大约六四开, 均值略有差距, 1的方差明显小一些
                   count_nonzero      mean       std
    draft_param3                                   
    0                    5258.0 -1.503943  0.394731
    1                    3547.0 -1.481769  0.323193
 
 - 10: 0/1/2: 0/1 差别不大, 2稍差一些
                   count_nonzero      mean       std
    draft_param10                                   
    0                     2047.0 -1.499100  0.380330
    1                     6148.0 -1.497139  0.360693
    2                      610.0 -1.459835  0.392974
 
 - 11: 0/1/3 为主, 2 似乎是离群值; 0/1/3/4相差不很大

                    count_nonzero      mean       std
    draft_param11                                   
    0                     2319.0 -1.490372  0.383701
    1                     2767.0 -1.516167  0.403437
    2                        3.0 -0.795488  0.455699
    3                     3554.0 -1.480729  0.323634
    4                      162.0 -1.526315  0.376954
 
param3,4,7,8

- 3: 几乎全是0, 2 只有一个样本, 1差别也不大
            count_nonzero      mean       std
    param3                                   
    0.0            8776.0 -1.494902  0.367388
    1.0              25.0 -1.525965  0.472348
    2.0               1.0 -1.879426       NaN
    
- 4: 8:1, 差别不大
            count_nonzero      mean       std
    param4                                   
    0.0            7797.0 -1.494967  0.366367
    1.0            1001.0 -1.493582  0.378113
    
- 7: 1的量 5%, 稍差于0
            count_nonzero      mean       std
    param7                                   
    0              8553.0 -1.497009  0.367179
    1               252.0 -1.427165  0.380601
- 8: 分布比较平均, 1,3 似乎稍好 
            count_nonzero      mean       std
    param8                                   
    0              1895.0 -1.564217  0.353631
    1              1947.0 -1.455031  0.392915
    2               511.0 -1.427405  0.382396
    3              1951.0 -1.555754  0.344816
    4              1990.0 -1.444013  0.359867
    5               511.0 -1.424977  0.342548

- 数值型变量可以 bin 之后做 plot

### 3.3 测试与提交

去掉 param2,4 后用 RF 预测提交

(预测时的结果和随机分组关系很大, 不同随机数可以从 0.67-0.71 波动, 而调整参数数量通常只在小数点第三位)

## 4 tparam 初探

目前分析 draft 和 param 进展不大, 试着分析一下 tparam, 看看能否有些结果.

### 4.1 初步可视化

选择一个批次的 tparam 分析:

plot value against time

数据有几类: 在某个值附近波动(2,3,4,5); 线性或类似线性变化(6,8,9,17,18); 部分数据有一个启动和终止的变化趋势(11,14,15,16).

对于波动的, 可用均值和标准差等衡量; 对于线性, 可用斜率截距等; 主要还是要比较不同 y 值的 tparam, 看其是否有区别.

### 4.2 对比不同 y 的结果

写了两个函数 wrapper 提取需要的 production_no 和对应的 tparam.

需要做的是把时间归一化, 整理为距开始时刻的时间.

然后即可把不同批次的结果 plot 到同一张图上, 进行对比分析.

选择了几个策略:

1. pivot 总和表, 用 pd.plot 作图. 但问题是每换一个变量都需要重新整理; 特别是 pivot 要求主键不一致, 导致必须再增加一步 `drop_duplicates`. 另外 pd.plot 的定义比较麻烦. 且很难把多个不同组, 如此处想做的 +/- 两组用不同颜色表示.
2. 直接用 plt.plot(x,y,param) 分开画多条线, 叠加到一起. 这是更直观简洁的方式. 而且每条线可以很好单独定义格式, 便于区分各个组.

然而看了 top50 和 least50 的对比: 没有太多的差异感觉.

- least50 有更多的停工比例 (tparam1 vs time)
- least50 在温度参数上异常值(偏高区间)出现频率似乎更高

为了增加对比, 又加入了 middle50, 然而也没发现什么明确的差异和思路.

初步看起来从 tparam 提取特征也没有特别明显的优质结果.

### 4.3 计划

从 tparam 初步提取一些特征, 一起建模.

希望能调参防止过拟合, 得到更好的结果. 用 k-fold cv 验证.


## 5 final dataset

训练集和测试集去除了 <0.85 的异常值.

### 5.1 k-fold cv

首先实现 k-fold cv (sklearn), k=5

### 5.2 test transform y

顺便测试了一下变换 y 的效果:

在不改变 模型的情况下: 用原始 y, 误差大约 0.030
用变换后的 y 误差大约 0.027

提升效果明显.

分析可能是变换之后的预测采用的误差函数有关(用 R^2 训练, 取对数后可能与最后的 RMSE 误差更接近)

### 5.3 PCA

PCA 可视化也没看到什么特别的规律

整合到 RF 模型中看效果: 几乎也没有变化.

考虑到大部分人的成绩 集中在 0.026-0.027 之间, 估计只用 draft 和 para 也没有太多成长空间.

### 5.4 tparam 测试

最后尝试提取一些 tparam 进行分析

